!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t=(new e.Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="dad20c65-54e1-4f4a-8fae-658a800d8059",e._sentryDebugIdIdentifier="sentry-dbid-dad20c65-54e1-4f4a-8fae-658a800d8059")}catch(e){}}();"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4492],{74492:function(e,t,i){i.d(t,{gY:function(){return d},kf:function(){return l},qg:function(){return c}});var n=i(1850),a=n.z.number().int().positive(),s=n.z.array(a),r=n.z.object({pinnedTools:s,theme:n.z.enum(["light","dark","system"])}),o=n.z.object({id:a,url:n.z.string().min(1),icon:n.z.unknown()});n.z.array(o);var d=class{userId;primaryStorage;cacheStorage;options;dualStorageOptions;cacheMetadataKey="_pinned_cache_metadata";defaultPinnedItems;syncTimeoutId=null;pendingSyncData=null;isDestroyed=!1;constructor(e,t,i,n){this.userId=e,this.primaryStorage=t,this.cacheStorage=i,this.dualStorageOptions={cacheExpiry:36e5,backgroundSync:!0,syncDebounceDelay:2e4},this.defaultPinnedItems=[14,20,16],this.options={enableDebug:!1,...n},this.setupCacheClearedCallback(),this.setupBeforeUnloadHandler()}setupCacheClearedCallback(){if(this.isCookieStorage(this.cacheStorage)){let e=this.cacheStorage.getCookieOptions();this.cacheStorage.updateCookieOptions({...e,onCookieCleared:()=>{this.debug("Cookie was cleared due to invalid data, clearing cache metadata"),this.clearCacheMetadata()}})}}setupBeforeUnloadHandler(){"undefined"!=typeof window&&window.addEventListener("beforeunload",()=>{this.pendingSyncData&&!this.isDestroyed&&this.flushPendingSync()})}validateItemId(e){try{return a.parse(e)}catch(i){let t=`Invalid element ID: ${e}`;throw this.options.enableDebug&&console.error(t,i),Error(t)}}debug(e,t){this.options.enableDebug&&console.log(`[PinnedSidebarClient] ${e}`,t)}getCacheMetadata(){try{if("undefined"==typeof localStorage)return null;let e=localStorage.getItem(this.cacheMetadataKey);if(!e)return null;return JSON.parse(e)}catch(e){return this.debug("Error reading cache metadata",e),null}}setCacheMetadata(){try{if("undefined"==typeof localStorage)return;let e={timestamp:Date.now(),userId:this.userId??0};localStorage.setItem(this.cacheMetadataKey,JSON.stringify(e))}catch(e){this.debug("Error saving cache metadata",e)}}clearCacheMetadata(){try{if("undefined"==typeof localStorage)return;localStorage.removeItem(this.cacheMetadataKey),this.debug("Cache metadata cleared")}catch(e){this.debug("Error clearing cache metadata",e)}}get isCacheExpired(){let e=this.getCacheMetadata();return!e||Date.now()-e.timestamp>this.dualStorageOptions.cacheExpiry||e.userId!==this.userId}async syncCacheWithPrimaryAsync(){try{if(this.pendingSyncData&&(this.debug("Pending sync detected during cache refresh, flushing first"),!await this.flushPendingSync())){this.debug("Failed to flush pending sync, cache refresh aborted");return}let e=await this.primaryStorage.getPinnedItems();this.cacheStorage.clearPinnedItems(),e.forEach(e=>this.cacheStorage.addPinnedItem(e)),this.setCacheMetadata(),this.debug("Cache synchronized with primary storage",{count:e.length})}catch(e){this.debug("Error in background sync",e)}}async syncWithPrimary(e){try{await this.primaryStorage.setPinnedItems(e)?(this.setCacheMetadata(),this.debug("Data synced with primary storage",{count:e.length})):this.debug("Failed to sync with primary storage")}catch(e){this.debug("Error syncing with primary storage",e)}}debouncedSyncWithPrimary(e){this.isDestroyed||(this.syncTimeoutId&&(clearTimeout(this.syncTimeoutId),this.debug("Previous sync timeout cancelled")),this.pendingSyncData=[...e],this.debug("Sync scheduled",{delay:this.dualStorageOptions.syncDebounceDelay,itemCount:e.length}),this.syncTimeoutId=setTimeout(async()=>{if(this.pendingSyncData&&!this.isDestroyed){this.debug("Executing debounced sync");try{await this.syncWithPrimary(this.pendingSyncData),this.debug("Debounced sync completed successfully")}catch(e){this.debug("Debounced sync failed, will retry on next operation",e);return}this.pendingSyncData=null,this.syncTimeoutId=null}},this.dualStorageOptions.syncDebounceDelay))}async flushPendingSync(){if(!this.pendingSyncData)return this.debug("No pending sync data to flush"),!0;this.syncTimeoutId&&(clearTimeout(this.syncTimeoutId),this.syncTimeoutId=null);try{return this.debug("Flushing pending sync data"),await this.syncWithPrimary(this.pendingSyncData),this.pendingSyncData=null,this.debug("Pending sync flushed successfully"),!0}catch(e){return this.debug("Error flushing pending sync",e),!1}}getSyncStatus(){var e;return{hasPendingSync:null!==this.pendingSyncData,pendingItemCount:null==(e=this.pendingSyncData)?void 0:e.length,timeUntilSync:this.syncTimeoutId?this.dualStorageOptions.syncDebounceDelay:void 0}}setSyncDebounceDelay(e){this.dualStorageOptions.syncDebounceDelay=e,this.debug("Sync debounce delay updated",{delay:e})}destroy(){this.isDestroyed=!0,this.syncTimeoutId&&(clearTimeout(this.syncTimeoutId),this.syncTimeoutId=null),this.pendingSyncData&&this.syncWithPrimary(this.pendingSyncData).catch(()=>{this.debug("Failed to sync pending data during destroy")}),this.debug("Client destroyed")}async getPinnedItems(){if(!this.userId)return this.debug("Serving default pinned items because user is not logged in",{count:this.defaultPinnedItems.length,userId:this.userId}),this.defaultPinnedItems;this.isCacheExpired&&await this.syncCacheWithPrimaryAsync();let e=this.cacheStorage.getPinnedItems(),t=e??this.defaultPinnedItems;return this.debug("Serving from cache",{count:t.length,usingDefaults:!(null==e?void 0:e.length)}),t}addPinnedItem(e){if(!this.userId)return!1;try{let t=this.validateItemId(e),i=this.cacheStorage.getPinnedItems(),n=i??this.defaultPinnedItems;if(n.includes(t))return this.debug(`Element ${t} was already pinned`),!1;let a=[...n,t];if(i||this.defaultPinnedItems.forEach(e=>this.cacheStorage.addPinnedItem(e)),this.cacheStorage.addPinnedItem(t))return this.debouncedSyncWithPrimary(a),this.debug(`Element ${t} added`),!0;return!1}catch(e){return this.debug("Error adding pinned element",e),!1}}removePinnedItem(e){if(!this.userId)return!1;try{let t=this.validateItemId(e),i=this.cacheStorage.getPinnedItems(),n=i??this.defaultPinnedItems;if(!n.includes(t))return this.debug(`Element ${t} was not pinned`),!1;if(i||this.defaultPinnedItems.forEach(e=>this.cacheStorage.addPinnedItem(e)),this.cacheStorage.removePinnedItem(t)){let e=n.filter(e=>e!==t);return this.debouncedSyncWithPrimary(e),this.debug(`Element ${t} removed`),!0}return!1}catch(e){return this.debug("Error removing pinned element",e),!1}}clearAll(){if(this.userId)try{this.cacheStorage.clearPinnedItems(),this.setCacheMetadata(),this.debouncedSyncWithPrimary([]),this.debug("All pinned elements cleared")}catch(e){this.debug("Error clearing pinned elements",e)}}async forceCacheRefresh(){try{return await this.syncCacheWithPrimaryAsync(),!0}catch(e){return this.debug("Error during force cache refresh",e),!1}}getCacheInfo(){if(!this.cacheStorage)return{hasCacheStorage:!1,isExpired:!0};let e=this.getCacheMetadata();return{hasCacheStorage:!0,isExpired:this.isCacheExpired,lastUpdated:e?new Date(e.timestamp):void 0,userId:(null==e?void 0:e.userId)??0,itemCount:this.cacheStorage.getPinnedCount()}}validateCacheData(){if(this.hasValidationMethods(this.cacheStorage)){let e=this.cacheStorage.validateCurrentData();return e&&(this.debug("Cache data was invalid and cleared, clearing metadata and will reload from primary storage"),this.clearCacheMetadata()),e}return this.debug("Validation not available for current storage type"),!1}updateCacheValidationOptions(e){this.hasValidationMethods(this.cacheStorage)?(this.cacheStorage.updateValidationOptions(e),this.debug("Cache validation options updated",e)):this.debug("Validation options update not available for current storage type")}hasValidationMethods(e){return"validateCurrentData"in e&&"updateValidationOptions"in e&&"function"==typeof e.validateCurrentData&&"function"==typeof e.updateValidationOptions}isCookieStorage(e){return"updateCookieOptions"in e&&"getCookieOptions"in e&&"function"==typeof e.updateCookieOptions&&"function"==typeof e.getCookieOptions}},c=class{options;pinnedCache=null;themeCache=null;lastInitialized=null;isInitializing=!1;error=null;cacheDuration=5e3;constructor(e){this.options={timeout:5e3,headers:{"Content-Type":"application/json"},requestOptions:{},...e}}get isCacheValid(){return null!==this.lastInitialized&&this.lastInitialized.getTime()+this.cacheDuration>Date.now()}updatePinnedCache(e){this.pinnedCache=e,this.lastInitialized=new Date}updateThemeCache(e){this.themeCache=e}async initialize(){if(!this.isInitializing){this.isInitializing=!0;try{let e=await this.makeRequest("GET","");if(e.success&&e.data){let t=r.parse(e.data);this.updatePinnedCache(t.pinnedTools),this.updateThemeCache(t.theme)}else this.error=Error("Failed to initialize PinnedApiStorage"),this.updatePinnedCache([])}catch(e){this.error=e,this.updatePinnedCache([])}finally{this.isInitializing=!1}}}async makeRequest(e,t="",i){let n=new AbortController,a=setTimeout(()=>n.abort(),this.options.timeout);try{let s=`${this.options.baseUrl}${t}`,r={method:e,headers:this.options.headers,signal:n.signal,...this.options.requestOptions};i&&["POST","PUT"].includes(e)&&(r.body=JSON.stringify(i));let o=await fetch(s,r);if(clearTimeout(a),!o.ok)throw Error(`HTTP ${o.status}: ${o.statusText}`);let d=await o.json();return{success:!0,data:d}}catch(e){return clearTimeout(a),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async getPinnedItems(){if(this.isCacheValid||(await this.initialize(),this.lastInitialized=new Date),this.error)throw this.error;return this.pinnedCache??[]}async setPinnedItems(e){try{let t=s.parse(e);if((await this.makeRequest("PUT","",{pinnedTools:t})).success)return this.updatePinnedCache(t),!0;return!1}catch(e){return console.warn("Error setting pinned items:",e),!1}}async getTheme(){return this.themeCache||await this.initialize(),this.themeCache??"system"}async setTheme(e){try{if((await this.makeRequest("PUT","",{theme:e})).success)return this.updateThemeCache(e),!0;return!1}catch(e){return console.warn("Error setting theme:",e),!1}}},h=class{options;constructor(e){this.options={enableDebug:!1,customValidator:()=>!0,...e}}isValidPinnedItems(e){try{let t;if(null==e)return this.debug("Data is null or undefined"),!1;try{t=s.parse(e)}catch(e){return this.debug("Zod parsing failed",e),!1}if(!this.options.customValidator(t))return this.debug("Custom validation failed"),!1;return this.debug("Data validation passed",{count:t.length}),!0}catch(e){return this.debug("Unexpected error during validation",e),!1}}validateItemId(e){try{return a.parse(e)}catch(t){return this.debug("Invalid item ID",{itemId:e,error:t}),null}}updateOptions(e){this.options={...this.options,...e},this.debug("Validation options updated",this.options)}getOptions(){return{...this.options}}debug(e,t){this.options.enableDebug&&console.log(`[CookieValidationClient] ${e}`,t)}},l=class{cookieName;options;validationClient;constructor(e="pinned_sidebar_items",t){this.cookieName=e,this.options={expires:365,path:"/",secure:"undefined"!=typeof window&&"https:"===window.location.protocol,sameSite:"lax",defaultPinnedItems:[14,20,16],...t},this.validationClient=new h({enableDebug:!1,...this.options.validation})}setCookie(e){if("undefined"==typeof document)return;let{expires:t,domain:i,path:n,secure:a,sameSite:s}=this.options,r=`${this.cookieName}=${encodeURIComponent(e)}`;if(t){let e=new Date;e.setTime(e.getTime()+864e5*t),r+=`; expires=${e.toUTCString()}`}i&&(r+=`; domain=${i}`),n&&(r+=`; path=${n}`),a&&(r+="; secure"),s&&(r+=`; samesite=${s}`),document.cookie=r}getCookie(){var e,t,i,n;if("undefined"==typeof document)return null;let a=`${this.cookieName}=`;for(let r of decodeURIComponent(document.cookie).split(";")){for(;" "===r.charAt(0);)r=r.substring(1);if(0===r.indexOf(a)){let o=r.substring(a.length,r.length);try{let i=JSON.parse(o);if(this.validationClient.isValidPinnedItems(i))return s.parse(i);console.warn("Invalid cookie data detected, clearing cookie"),this.deleteCookie(),null==(t=(e=this.options).onCookieCleared)||t.call(e);break}catch(e){console.warn("Error parsing pinned items from cookie, clearing cookie:",e),this.deleteCookie(),null==(n=(i=this.options).onCookieCleared)||n.call(i);break}}}return null}deleteCookie(){if("undefined"==typeof document)return;let{domain:e,path:t}=this.options,i=`${this.cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC`;e&&(i+=`; domain=${e}`),t&&(i+=`; path=${t}`),document.cookie=i}getStoredData(){return this.getCookie()}saveStoredData(e){try{this.validationClient.isValidPinnedItems(e)?this.setCookie(JSON.stringify(e)):console.error("Cannot save invalid data to cookie")}catch(e){console.error("Error saving pinned items to cookie:",e)}}getPinnedItems(){return this.getStoredData()}addPinnedItem(e){let t=this.validationClient.validateItemId(e);if(!t)return console.warn("Invalid ID rejected:",e),!1;let i=this.getStoredData();if(null==i?void 0:i.includes(t))return!1;let n=[...i??[],t];return this.saveStoredData(n),!0}removePinnedItem(e){let t=this.validationClient.validateItemId(e);if(!t)return console.warn("Invalid ID rejected:",e),!1;let i=this.getStoredData();if(-1===((null==i?void 0:i.indexOf(t))??-1))return!1;let n=(null==i?void 0:i.filter(e=>e!==t))??[];return this.saveStoredData(n),!0}isPinned(e){let t=this.validationClient.validateItemId(e);if(!t)return!1;let i=this.getStoredData();return(null==i?void 0:i.includes(t))??!1}clearPinnedItems(){this.deleteCookie()}getPinnedCount(){var e;return(null==(e=this.getStoredData())?void 0:e.length)??0}updateCookieOptions(e){this.options={...this.options,...e};let t=this.getStoredData();(null==t?void 0:t.length)&&this.saveStoredData(t)}getCookieOptions(){return{...this.options}}updateValidationOptions(e){this.validationClient.updateOptions(e)}validateCurrentData(){var e,t;let i=this.getRawCookieData();return!!i&&!this.validationClient.isValidPinnedItems(i)&&(console.warn("Cookie data validation failed, clearing cookie"),this.deleteCookie(),null==(t=(e=this.options).onCookieCleared)||t.call(e),!0)}getRawCookieData(){if("undefined"==typeof document)return null;let e=`${this.cookieName}=`;for(let t of decodeURIComponent(document.cookie).split(";")){for(;" "===t.charAt(0);)t=t.substring(1);if(0===t.indexOf(e)){let i=t.substring(e.length,t.length);try{return JSON.parse(i)}catch(e){return i}}}return null}}}}]);